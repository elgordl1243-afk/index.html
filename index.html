<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Control de Stock iPhone ‚Äî Cloud (Neon)</title>
  <style>
    :root{--bg:#0b0d12;--text:#e8ecf6;--muted:#9aa4bf;--line:#24304a;--ok:#34d399;--warn:#fbbf24;--bad:#fb7185;--shadow:0 10px 30px rgba(0,0,0,.35);--radius:18px}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:radial-gradient(1200px 600px at 20% 0%, rgba(110,231,255,.10), transparent 55%),radial-gradient(1200px 600px at 80% 0%, rgba(167,139,250,.10), transparent 55%),var(--bg);color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto;padding:22px}
    header{display:flex;gap:14px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;margin-bottom:16px}
    .brand{display:flex;flex-direction:column;gap:8px}
    .brand h1{margin:0;font-size:20px;display:flex;align-items:center;gap:10px}
    .topbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line);background:rgba(255,255,255,.03);border-radius:999px;color:var(--muted);font-size:12px;width:max-content}
    .pill strong{color:var(--text);font-weight:700}
    .dot{width:8px;height:8px;border-radius:999px;display:inline-block;background:rgba(255,255,255,.35)}
    .dot.ok{background:rgba(52,211,153,.85)}
    .dot.warn{background:rgba(251,191,36,.85)}
    .dot.bad{background:rgba(251,113,133,.85)}
    button{border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;transition:.15s ease;font-weight:700;font-size:13px;display:inline-flex;align-items:center;gap:8px}
    button:hover{transform:translateY(-1px);border-color:#34507a}
    button.primary{background:linear-gradient(135deg, rgba(110,231,255,.20), rgba(167,139,250,.20));border-color:rgba(110,231,255,.35)}
    button.danger{border-color:rgba(251,113,133,.35)}
    button:disabled{opacity:.5;cursor:not-allowed;transform:none}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .card .hd{padding:14px 14px 10px;border-bottom:1px solid rgba(36,48,74,.7);display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .card .hd h2{margin:0;font-size:14px;color:var(--text)}
    .card .bd{padding:14px}
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width:900px){.stats{grid-template-columns:repeat(2,1fr)}}
    .stat{background:rgba(15,20,34,.7);border:1px solid rgba(36,48,74,.7);border-radius:16px;padding:12px;min-height:74px;display:flex;flex-direction:column;justify-content:space-between}
    .stat .k{color:var(--muted);font-size:12px}
    .stat .v{font-size:18px;font-weight:900}
    .stat .s{color:var(--muted);font-size:12px}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;margin-bottom:10px}
    .field{grid-column:span 3;display:flex;flex-direction:column;gap:6px}
    .field.span-2{grid-column:span 2}.field.span-3{grid-column:span 3}.field.span-6{grid-column:span 6}.field.span-12{grid-column:span 12}
    @media (max-width:980px){.field{grid-column:span 6}.field.span-2,.field.span-3,.field.span-6{grid-column:span 6}.field.span-12{grid-column:span 12}}
    @media (max-width:520px){.field{grid-column:span 12}}
    label{font-size:12px;color:var(--muted)}
    input,select{width:100%;padding:10px 10px;border-radius:12px;border:1px solid rgba(36,48,74,.9);background:rgba(0,0,0,.18);color:var(--text);outline:none;font-size:13px}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{padding:6px 10px;border-radius:999px;background:rgba(24,32,58,.75);border:1px solid rgba(36,48,74,.7);font-size:12px;color:var(--muted);display:inline-flex;gap:6px;align-items:center}
    .chip b{color:var(--text)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .tablewrap{overflow:auto;border-radius:16px;border:1px solid rgba(36,48,74,.7)}
    table{width:100%;border-collapse:collapse;min-width:980px;background:rgba(15,20,34,.55)}
    thead th{text-align:left;font-size:12px;color:var(--muted);font-weight:800;padding:12px 10px;border-bottom:1px solid rgba(36,48,74,.7);position:sticky;top:0;background:rgba(15,20,34,.95);backdrop-filter:blur(6px);white-space:nowrap}
    tbody td{padding:12px 10px;border-bottom:1px solid rgba(36,48,74,.45);font-size:13px;vertical-align:top}
    .badge{display:inline-flex;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:900;border:1px solid rgba(36,48,74,.7);background:rgba(24,32,58,.75);white-space:nowrap}
    .b-ok{color:var(--ok);border-color:rgba(52,211,153,.35)}
    .b-warn{color:var(--warn);border-color:rgba(251,191,36,.35)}
    .b-bad{color:var(--bad);border-color:rgba(251,113,133,.35)}
    .mini{color:var(--muted);font-size:12px;white-space:nowrap}
    .money{font-variant-numeric:tabular-nums;white-space:nowrap}
    .split{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .row-actions{display:flex;gap:8px;flex-wrap:wrap}
    .row-actions button{padding:8px 10px;border-radius:10px}
    .inputWithBtn{display:flex;gap:8px}
    .inputWithBtn input{flex:1}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>üì± Control de Stock iPhone ‚Äî Cloud (Neon)</h1>
        <div class="pill">
          <span id="cloudDot" class="dot warn"></span>
          <span id="cloudText">Desconectado</span>
          <span class="muted">‚Ä¢</span>
          TC global (ARS/USD): <strong id="tcPill">‚Äî</strong>
          <span class="muted">‚Ä¢</span>
          <span class="muted">Vendido congela TC</span>
        </div>
      </div>

      <div class="topbar">
        <input id="appKey" placeholder="Clave de la app (APP_KEY)" style="min-width:260px" />
        <button id="btnConnect" class="primary">üîå Conectar</button>
        <button id="btnExportJson" disabled>Export JSON</button>
        <button id="btnImportJson" disabled>Import JSON</button>
        <button id="btnExportCsv" disabled>Export CSV</button>
        <button id="btnClear" class="danger" disabled>Borrar todo</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="hd">
          <h2>Alta / Edici√≥n de equipo</h2>
          <div class="chips" id="calcChips"></div>
        </div>

        <div class="bd">
          <div class="stats" id="stats"></div>
          <div style="height:12px"></div>

          <form id="form">
            <div class="row">
              <div class="field span-3">
                <label>Modelo</label>
                <select id="model" required>
                  <option value="">Seleccionar‚Ä¶</option>
                  <option>iPhone 11</option><option>iPhone 11 Pro</option><option>iPhone 11 Pro Max</option>
                  <option>iPhone 12</option><option>iPhone 12 mini</option><option>iPhone 12 Pro</option><option>iPhone 12 Pro Max</option>
                  <option>iPhone 13</option><option>iPhone 13 mini</option><option>iPhone 13 Pro</option><option>iPhone 13 Pro Max</option>
                  <option>iPhone 14</option><option>iPhone 14 Plus</option><option>iPhone 14 Pro</option><option>iPhone 14 Pro Max</option>
                  <option>iPhone 15</option><option>iPhone 15 Plus</option><option>iPhone 15 Pro</option><option>iPhone 15 Pro Max</option>
                  <option>iPhone 16</option><option>iPhone 16 Plus</option><option>iPhone 16 Pro</option><option>iPhone 16 Pro Max</option>
                </select>
              </div>

              <div class="field span-2">
                <label>GB</label>
                <select id="storage" required>
                  <option value="">‚Äî</option>
                  <option>64</option><option>128</option><option>256</option><option>512</option><option>1024</option>
                </select>
              </div>

              <div class="field span-3">
                <label>Color</label>
                <input id="color" placeholder="Ej: Blue / Black / Sierra Blue" required />
              </div>

              <div class="field span-2">
                <label>Bater√≠a %</label>
                <input id="battery" type="number" min="0" max="100" step="1" placeholder="85" />
              </div>

              <div class="field span-2">
                <label>Condici√≥n</label>
                <select id="condition">
                  <option>Excelente</option>
                  <option>Muy buena</option>
                  <option>Buena</option>
                  <option>Detalle est√©tico</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div class="field span-6">
                <label>IMEI / Serie</label>
                <div class="inputWithBtn">
                  <input id="imei" placeholder="Peg√° el IMEI/serie" />
                  <button type="button" id="btnGenImei">üé≤ ID</button>
                </div>
                <div class="hint">Tip: si no us√°s scanner, toc√° ‚ÄúID‚Äù para generar uno interno.</div>
              </div>

              <div class="field span-3">
                <label>Proveedor / Origen</label>
                <input id="supplier" placeholder="Ej: Mayorista / Particular / Canje" />
              </div>

              <div class="field span-3">
                <label>Fecha ingreso</label>
                <input id="dateIn" type="date" />
              </div>
            </div>

            <div class="row">
              <div class="field span-3">
                <label>Estado</label>
                <select id="status">
                  <option value="Disponible">Disponible</option>
                  <option value="Reservado">Reservado</option>
                  <option value="Vendido">Vendido</option>
                </select>
                <div class="hint">Al pasar a <b>Vendido</b>, se congela el TC.</div>
              </div>

              <div class="field span-3">
                <label>Tipo de cambio global (ARS/USD)</label>
                <input id="rate" type="number" min="0" step="0.01" placeholder="Ej: 1200" required />
              </div>

              <div class="field span-2">
                <label>Costo USD</label>
                <input id="costUsd" type="number" min="0" step="0.01" placeholder="Ej: 350" required />
              </div>

              <div class="field span-2">
                <label>Precio final USD</label>
                <input id="priceUsd" type="number" min="0" step="0.01" placeholder="Ej: 420" required />
              </div>

              <div class="field span-2">
                <label>Fees / Gastos ARS</label>
                <input id="feesArs" type="number" min="0" step="1" placeholder="Ej: 5000" value="0" />
              </div>
            </div>

            <div class="row">
              <div class="field span-12">
                <label>Notas</label>
                <input id="notes" placeholder="Ej: con caja, garant√≠a 30 d√≠as, etc." />
              </div>
            </div>

            <div class="split">
              <div class="hint" id="saveHint"></div>
              <div class="row-actions">
                <button type="button" id="btnReset">Limpiar</button>
                <button type="submit" class="primary" id="btnSave">Guardar</button>
              </div>
            </div>

            <input type="hidden" id="editingId" value="" />
          </form>
        </div>
      </section>

      <section class="card">
        <div class="hd">
          <h2>Stock</h2>
          <div class="toolbar">
            <div class="field span-6" style="min-width:260px">
              <label>B√∫squeda</label>
              <input id="q" placeholder="Modelo, GB, color, IMEI‚Ä¶" />
            </div>
            <div class="field span-3" style="min-width:170px">
              <label>Filtrar estado</label>
              <select id="filterStatus">
                <option value="">Todos</option>
                <option value="Disponible">Disponible</option>
                <option value="Reservado">Reservado</option>
                <option value="Vendido">Vendido</option>
              </select>
            </div>
            <div class="field span-3" style="min-width:170px">
              <label>Orden</label>
              <select id="sortBy">
                <option value="dateIn_desc">Ingreso (nuevo‚Üíviejo)</option>
                <option value="dateIn_asc">Ingreso (viejo‚Üínuevo)</option>
                <option value="profit_desc">Ganancia ARS (‚Üì)</option>
                <option value="profit_asc">Ganancia ARS (‚Üë)</option>
                <option value="model_asc">Modelo (A‚ÜíZ)</option>
                <option value="price_desc">Precio USD (‚Üì)</option>
              </select>
            </div>
          </div>
        </div>

        <div class="bd">
          <div class="tablewrap">
            <table>
              <thead>
                <tr>
                  <th>Equipo</th>
                  <th>IMEI/Serie</th>
                  <th>Estado</th>
                  <th>Costo</th>
                  <th>Precio</th>
                  <th>Ganancia</th>
                  <th>Ingreso</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>

          <div style="height:10px"></div>
          <div class="split">
            <div class="hint" id="countNote">‚Äî</div>
            <div class="hint" id="syncNote">Conect√° para sincronizar.</div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    /**********************************************************************
     * ‚úÖ Cloud por Netlify Functions + Neon (Postgres)
     * - Lee/escribe en /.netlify/functions/stock
     * - Cache localStorage + refresh autom√°tico (para que se actualice en el celu)
     **********************************************************************/
    const state = { settings: { rate: 0 }, items: [] };
    let connected = false;
    let polling = null;

    const $ = (id) => document.getElementById(id);

    const cloudDot = $("cloudDot");
    const cloudText = $("cloudText");
    const syncNote = $("syncNote");
    const tcPill = $("tcPill");

    const appKey = $("appKey");
    const btnConnect = $("btnConnect");
    const btnExportJson = $("btnExportJson");
    const btnImportJson = $("btnImportJson");
    const btnExportCsv = $("btnExportCsv");
    const btnClear = $("btnClear");

    const form = $("form");
    const model = $("model");
    const storage = $("storage");
    const color = $("color");
    const battery = $("battery");
    const condition = $("condition");
    const imei = $("imei");
    const supplier = $("supplier");
    const status = $("status");
    const dateIn = $("dateIn");
    const rate = $("rate");
    const costUsd = $("costUsd");
    const priceUsd = $("priceUsd");
    const feesArs = $("feesArs");
    const notes = $("notes");
    const editingId = $("editingId");

    const tbody = $("tbody");
    const stats = $("stats");
    const calcChips = $("calcChips");
    const q = $("q");
    const filterStatus = $("filterStatus");
    const sortBy = $("sortBy");
    const countNote = $("countNote");
    const saveHint = $("saveHint");
    const btnReset = $("btnReset");
    const btnGenImei = $("btnGenImei");

    setEnabled(false);
    if (!dateIn.value) dateIn.value = toISODate(new Date());
    feesArs.value = "0";

    // Cache local (para abrir r√°pido)
    const CACHE_KEY = "iphone_stock_cache_v1";
    const cached = loadCache();
    if (cached) {
      state.settings = cached.settings || { rate: 0 };
      state.items = Array.isArray(cached.items) ? cached.items : [];
      rate.value = state.settings.rate || "";
      render();
      setCloudStatus("warn", "Cache");
      syncNote.textContent = "Mostrando cache. Conect√° para actualizar.";
    } else {
      render();
    }

    btnConnect.addEventListener("click", async () => {
      const key = (appKey.value || "").trim();
      if (!key) return alert("Peg√° tu APP_KEY (la defin√≠s en Netlify).");

      localStorage.setItem("APP_KEY_LAST", key);
      await connectAndStart();
    });

    // Restaura clave guardada (opcional)
    const lastKey = localStorage.getItem("APP_KEY_LAST");
    if (lastKey) appKey.value = lastKey;

    async function connectAndStart(){
      try {
        setCloudStatus("warn", "Conectando‚Ä¶");
        syncNote.textContent = "Conectando‚Ä¶";

        await pullFromCloud(true);

        connected = true;
        setEnabled(true);
        setCloudStatus("ok", "Conectado");
        syncNote.textContent = "‚úÖ Sincronizado";

        // Polling para multi-dispositivo (cada 7s)
        if (polling) clearInterval(polling);
        polling = setInterval(() => pullFromCloud(false), 7000);

      } catch (e) {
        console.error(e);
        connected = false;
        setEnabled(false);
        setCloudStatus("bad", "Error");
        syncNote.textContent = "‚ùå No pudo cargar del servidor: " + (e.message || String(e));
        alert(syncNote.textContent);
      }
    }

    async function pullFromCloud(showAlert){
      const res = await apiGet();
      // res = { settings, items, updatedAt }
      if (!res || !res.settings || !Array.isArray(res.items)) throw new Error("Respuesta inv√°lida del servidor");
      state.settings = res.settings || { rate: 0 };
      state.items = res.items || [];
      rate.value = state.settings.rate || "";
      saveCache({ settings: state.settings, items: state.items });
      render();
      if (showAlert) {} // no alert por defecto
    }

    let saveTimer = null;
    function saveCloudDebounced(){
      if (!connected) return;
      clearTimeout(saveTimer);
      saveTimer = setTimeout(async () => {
        try {
          setCloudStatus("warn", "Guardando‚Ä¶");
          syncNote.textContent = "Guardando‚Ä¶";
          await apiPut({ settings: state.settings, items: state.items });
          setCloudStatus("ok", "Conectado");
          syncNote.textContent = "‚úÖ Guardado";
          saveCache({ settings: state.settings, items: state.items });
        } catch (e) {
          console.error(e);
          setCloudStatus("bad", "Error");
          syncNote.textContent = "‚ùå Error guardando: " + (e.message || String(e));
        }
      }, 250);
    }

    function setCloudStatus(kind, text){
      cloudText.textContent = text;
      cloudDot.classList.remove("ok","warn","bad");
      cloudDot.classList.add(kind);
    }

    function setEnabled(on){
      [btnExportJson, btnImportJson, btnExportCsv, btnClear].forEach(b => b.disabled = !on);
      Array.from(form.querySelectorAll("input,select,button")).forEach(el => el.disabled = !on);
      q.disabled = !on;
      filterStatus.disabled = !on;
      sortBy.disabled = !on;
      appKey.disabled = on; // bloquea la clave cuando conecta
      btnConnect.disabled = on;
    }

    /**********************************************************************
     * ‚úÖ TC congelado en Vendido
     **********************************************************************/
    function effectiveRateFor(it){
      const globalR = num(rate.value) || num(state.settings.rate) || 0;
      if (it.status === "Vendido" && num(it.soldRate) > 0) return num(it.soldRate);
      return globalR;
    }
    function calcWithRate(it) {
      const r = effectiveRateFor(it);
      const cArs = (it.costUsd || 0) * r;
      const pArs = (it.priceUsd || 0) * r;
      const gArs = pArs - cArs - (it.feesArs || 0);
      const gUsd = r ? gArs / r : 0;
      return { r, cArs, pArs, gArs, gUsd };
    }

    function recalcChips() {
      const r = num(rate.value);
      tcPill.textContent = r ? fmtARS(r) : "‚Äî";
      const cUSD = num(costUsd.value);
      const pUSD = num(priceUsd.value);
      const fees = num(feesArs.value);
      const cARS = cUSD * r;
      const pARS = pUSD * r;
      const gARS = pARS - cARS - fees;
      const gUSD = r ? (gARS / r) : 0;

      calcChips.innerHTML = `
        <span class="chip">Costo ARS: <b class="money">${fmtARS(cARS)}</b></span>
        <span class="chip">Precio ARS: <b class="money">${fmtARS(pARS)}</b></span>
        <span class="chip">Ganancia ARS: <b class="money">${fmtARS(gARS)}</b></span>
        <span class="chip">Ganancia USD: <b class="money">${fmtUSD(gUSD)}</b></span>
      `;
    }

    ["input","change"].forEach(ev => rate.addEventListener(ev, () => {
      state.settings.rate = num(rate.value);
      recalcChips();
      render();
      saveCloudDebounced();
    }));
    ["input","change"].forEach(ev => [costUsd, priceUsd, feesArs].forEach(el => el.addEventListener(ev, recalcChips)));

    /**********************************************************************
     * ‚úÖ Guardar / editar
     **********************************************************************/
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      saveHint.textContent = "";

      const item = buildItemFromForm();
      if (!item) return;

      if (editingId.value) {
        const idx = state.items.findIndex(x => x.id === editingId.value);
        if (idx >= 0) state.items[idx] = item;
        saveHint.textContent = "‚úÖ Equipo actualizado.";
      } else {
        state.items.unshift(item);
        saveHint.textContent = "‚úÖ Equipo agregado al stock.";
      }

      saveCloudDebounced();
      resetForm(false);
      render();
    });

    btnReset.addEventListener("click", () => resetForm(true));
    btnGenImei.addEventListener("click", () => { imei.value = cryptoId(); });

    function resetForm(clearRate) {
      editingId.value = "";
      form.reset();
      dateIn.value = toISODate(new Date());
      feesArs.value = "0";
      status.value = "Disponible";
      condition.value = "Excelente";
      if (!clearRate) rate.value = state.settings.rate || "";
      recalcChips();
    }

    function buildItemFromForm() {
      const globalR = num(rate.value);
      if (!connected) {
        alert("Conect√° primero (APP_KEY).");
        return null;
      }
      if (!model.value || !storage.value || !color.value || !globalR) {
        alert("Complet√°: Modelo, GB, Color y Tipo de cambio.");
        return null;
      }
      const cUSD = num(costUsd.value);
      const pUSD = num(priceUsd.value);
      if (cUSD <= 0 || pUSD <= 0) {
        alert("Costo USD y Precio USD deben ser mayores a 0.");
        return null;
      }

      const isEditing = !!editingId.value;
      const prev = isEditing ? state.items.find(x => x.id === editingId.value) : null;

      const newStatus = status.value;
      const prevStatus = prev?.status || null;

      let soldRate = prev?.soldRate ?? null;
      let soldAt = prev?.soldAt ?? null;

      const becomingSold = (newStatus === "Vendido") && (prevStatus !== "Vendido");
      const isNewSold = (!prev && newStatus === "Vendido");

      if (becomingSold || isNewSold) {
        soldRate = globalR;
        soldAt = Date.now();
      }

      const id = editingId.value || cryptoId();

      return {
        id,
        model: model.value,
        storageGB: Number(storage.value),
        color: color.value.trim(),
        battery: battery.value ? clampInt(Number(battery.value), 0, 100) : null,
        condition: condition.value,
        imei: imei.value.trim(),
        supplier: supplier.value.trim(),
        status: newStatus,
        dateIn: dateIn.value || toISODate(new Date()),
        costUsd: cUSD,
        priceUsd: pUSD,
        feesArs: num(feesArs.value),
        notes: notes.value.trim(),
        soldRate,
        soldAt,
        updatedAt: Date.now()
      };
    }

    function editItem(id) {
      const it = state.items.find(x => x.id === id);
      if (!it) return;

      editingId.value = it.id;
      model.value = it.model;
      storage.value = String(it.storageGB);
      color.value = it.color;
      battery.value = it.battery ?? "";
      condition.value = it.condition;
      imei.value = it.imei || "";
      supplier.value = it.supplier || "";
      status.value = it.status;
      dateIn.value = it.dateIn || toISODate(new Date());
      costUsd.value = it.costUsd;
      priceUsd.value = it.priceUsd;
      feesArs.value = it.feesArs || 0;
      notes.value = it.notes || "";
      window.scrollTo({ top: 0, behavior: "smooth" });
      saveHint.textContent = it.status === "Vendido" && num(it.soldRate) > 0
        ? `‚úèÔ∏è Editando vendido (TC congelado: ${fmtARS(num(it.soldRate))}).`
        : "‚úèÔ∏è Editando equipo. Guard√° para aplicar cambios.";
      recalcChips();
    }

    function delItem(id) {
      const it = state.items.find(x => x.id === id);
      if (!it) return;
      const ok = confirm(`¬øBorrar "${it.model} ${it.storageGB}GB ${it.color}"?`);
      if (!ok) return;
      state.items = state.items.filter(x => x.id !== id);
      saveCloudDebounced();
      render();
    }

    function toggleStatus(id) {
      const it = state.items.find(x => x.id === id);
      if (!it) return;

      const order = ["Disponible","Reservado","Vendido"];
      const idx = order.indexOf(it.status);
      const next = order[(idx + 1) % order.length];

      if (next === "Vendido" && it.status !== "Vendido") {
        it.soldRate = num(rate.value) || num(state.settings.rate) || 0;
        it.soldAt = Date.now();
      }

      it.status = next;
      it.updatedAt = Date.now();

      saveCloudDebounced();
      render();
    }

    /**********************************************************************
     * ‚úÖ Render
     **********************************************************************/
    function applyQuerySort(items) {
      const qq = (q.value || "").trim().toLowerCase();
      const st = filterStatus.value;

      let out = items.filter(it => {
        if (st && it.status !== st) return false;
        if (!qq) return true;
        const blob = [it.model, it.storageGB, it.color, it.imei, it.condition, it.supplier, it.notes].join(" ").toLowerCase();
        return blob.includes(qq);
      });

      const sort = sortBy.value;
      const [key, dir] = sort.split("_");
      const asc = dir === "asc";

      out.sort((a,b) => {
        let av, bv;
        if (key === "dateIn") { av = a.dateIn || ""; bv = b.dateIn || ""; }
        else if (key === "profit") { av = calcWithRate(a).gArs; bv = calcWithRate(b).gArs; }
        else if (key === "price") { av = a.priceUsd; bv = b.priceUsd; }
        else if (key === "model") { av = (a.model + " " + a.storageGB).toLowerCase(); bv = (b.model + " " + b.storageGB).toLowerCase(); }
        else { av = a.updatedAt; bv = b.updatedAt; }
        if (av < bv) return asc ? -1 : 1;
        if (av > bv) return asc ? 1 : -1;
        return 0;
      });

      countNote.textContent = `${out.length} resultado(s) ‚Ä¢ Total registros: ${state.items.length}`;
      return out;
    }

    function renderTable(items) {
      tbody.innerHTML = items.map(it => {
        const { r, cArs, pArs, gArs, gUsd } = calcWithRate(it);
        const name = `${escapeHtml(it.model)} ‚Ä¢ ${it.storageGB}GB ‚Ä¢ ${escapeHtml(it.color)}` + (it.battery !== null ? ` ‚Ä¢ üîã${it.battery}%` : "");
        const imeiTxt = it.imei ? escapeHtml(it.imei) : `<span class="mini">‚Äî</span>`;
        const profitClass = gArs >= 0 ? "b-ok" : "b-bad";
        const rateNote = it.status === "Vendido"
          ? `<span class="mini">TC congelado: ${fmtARS(num(it.soldRate)||r)}</span>`
          : `<span class="mini">TC global: ${fmtARS(r)}</span>`;

        return `
          <tr>
            <td>
              <div style="font-weight:900">${name}</div>
              <div class="mini">${escapeHtml(it.condition)}${it.supplier ? " ‚Ä¢ " + escapeHtml(it.supplier) : ""}${it.notes ? " ‚Ä¢ " + escapeHtml(it.notes) : ""}</div>
              <div>${rateNote}</div>
            </td>
            <td class="mini">${imeiTxt}</td>
            <td>${badgeFor(it.status)}</td>
            <td><div class="money"><b>${fmtUSD(it.costUsd)}</b></div><div class="mini money">${fmtARS(cArs)}</div></td>
            <td><div class="money"><b>${fmtUSD(it.priceUsd)}</b></div><div class="mini money">${fmtARS(pArs)}</div></td>
            <td><span class="badge ${profitClass}">${fmtARS(gArs)}</span><div class="mini money">${fmtUSD(gUsd)}</div></td>
            <td class="mini">${escapeHtml(it.dateIn || "‚Äî")}</td>
            <td>
              <div class="row-actions">
                <button data-edit="${it.id}">Editar</button>
                <button data-toggle="${it.id}">Cambiar estado</button>
                <button class="danger" data-del="${it.id}">Borrar</button>
              </div>
            </td>
          </tr>
        `;
      }).join("");

      tbody.querySelectorAll("[data-edit]").forEach(btn => btn.addEventListener("click", () => editItem(btn.dataset.edit)));
      tbody.querySelectorAll("[data-del]").forEach(btn => btn.addEventListener("click", () => delItem(btn.dataset.del)));
      tbody.querySelectorAll("[data-toggle]").forEach(btn => btn.addEventListener("click", () => toggleStatus(btn.dataset.toggle)));
    }

    function renderStats() {
      const items = state.items || [];
      const avail = items.filter(x => x.status === "Disponible");
      const reserved = items.filter(x => x.status === "Reservado");
      const sold = items.filter(x => x.status === "Vendido");
      const notSold = [...avail, ...reserved];

      const sumCalc = (arr, selector) => arr.reduce((acc, it) => acc + selector(calcWithRate(it), it), 0);

      const investedARS = sumCalc(notSold, (c) => c.cArs);
      const potentialProfitARS = sumCalc(notSold, (c) => c.gArs);
      const soldProfitARS = sumCalc(sold, (c) => c.gArs);
      const soldRevenueARS = sumCalc(sold, (c) => c.pArs);

      // USD
      const investedUSD = notSold.reduce((a,it)=>a+num(it.costUsd||0),0);
      const potentialProfitUSD = sumCalc(notSold, (c)=>c.gUsd);
      const soldProfitUSD = sumCalc(sold, (c)=>c.gUsd);
      const soldRevenueUSD = sold.reduce((a,it)=>a+num(it.priceUsd||0),0);

      stats.innerHTML = `
        ${stat("Disponibles", avail.length, "En stock")}
        ${stat("Reservados", reserved.length, "Pendientes")}
        ${stat("Vendidos", sold.length, "TC congelado")}
        ${stat("Invertido", `${fmtARS(investedARS)}<div class="mini money">${fmtUSD(investedUSD)}</div>`, "Disp + reserv")}
        ${stat("Ganancia potencial", `${fmtARS(potentialProfitARS)}<div class="mini money">${fmtUSD(potentialProfitUSD)}</div>`, "Disp + reserv")}
        ${stat("Ganancia vendida", `${fmtARS(soldProfitARS)}<div class="mini money">${fmtUSD(soldProfitUSD)}</div>`, "Hist√≥rico")}
        ${stat("Facturaci√≥n vendida", `${fmtARS(soldRevenueARS)}<div class="mini money">${fmtUSD(soldRevenueUSD)}</div>`, "Hist√≥rico")}
      `;
    }

    function render() {
      renderStats();
      renderTable(applyQuerySort([...state.items]));
      recalcChips();
    }

    function stat(k, v, s) {
      return `
        <div class="stat">
          <div class="k">${escapeHtml(k)}</div>
          <div class="v">${typeof v === "number" ? v : v}</div>
          <div class="s">${escapeHtml(s)}</div>
        </div>
      `;
    }
    function badgeFor(st) {
      if (st === "Disponible") return `<span class="badge b-ok">Disponible</span>`;
      if (st === "Reservado") return `<span class="badge b-warn">Reservado</span>`;
      return `<span class="badge b-bad">Vendido</span>`;
    }

    [q, filterStatus, sortBy].forEach(el => { el.addEventListener("input", render); el.addEventListener("change", render); });

    /**********************************************************************
     * ‚úÖ Export / Import / Clear
     **********************************************************************/
    btnExportJson.addEventListener("click", () => {
      const payload = JSON.stringify({ settings: state.settings, items: state.items }, null, 2);
      downloadText(payload, `stock-backup-${toISODate(new Date())}.json`, "application/json");
    });

    btnExportCsv.addEventListener("click", () => {
      const headers = ["id","model","storageGB","color","battery","condition","imei","supplier","status","dateIn","costUsd","priceUsd","feesArs","notes","soldRate","soldAt","updatedAt"];
      const rows = state.items.map(it => headers.map(h => csvCell(it[h])));
      const csv = [headers.join(","), ...rows.map(r => r.join(","))].join("\n");
      downloadText(csv, `stock-${toISODate(new Date())}.csv`, "text/csv");
    });

    btnImportJson.addEventListener("click", async () => {
      const txt = prompt("Peg√° el JSON exportado (reemplaza todo):");
      if (!txt) return;
      try {
        const data = JSON.parse(txt);
        if (!data || !Array.isArray(data.items)) throw new Error("Formato inv√°lido");
        state.settings = data.settings || { rate: 0 };
        state.items = data.items || [];
        rate.value = state.settings.rate || "";
        render();
        saveCloudDebounced();
      } catch (e) {
        alert("Error importando: " + (e.message || String(e)));
      }
    });

    btnClear.addEventListener("click", () => {
      const ok = confirm("Esto borra TODO el stock en la nube. ¬øContinuar?");
      if (!ok) return;
      state.items = [];
      state.settings = { rate: num(rate.value) || 0 };
      render();
      saveCloudDebounced();
    });

    /**********************************************************************
     * ‚úÖ API Netlify Functions
     **********************************************************************/
    async function apiGet(){
      const res = await fetch("/.netlify/functions/stock", {
        method: "GET",
        headers: { "x-app-key": (appKey.value || "").trim() }
      });
      if (!res.ok) {
        const t = await res.text().catch(()=> "");
        throw new Error(`${res.status} ${res.statusText} ${t}`.trim());
      }
      return await res.json();
    }

    async function apiPut(payload){
      const res = await fetch("/.netlify/functions/stock", {
        method: "PUT",
        headers: {
          "content-type": "application/json",
          "x-app-key": (appKey.value || "").trim()
        },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        const t = await res.text().catch(()=> "");
        throw new Error(`${res.status} ${res.statusText} ${t}`.trim());
      }
      return await res.json();
    }

    /**********************************************************************
     * ‚úÖ Helpers
     **********************************************************************/
    function num(v) {
      const n = Number(String(v).replace(",", "."));
      return Number.isFinite(n) ? n : 0;
    }
    function clampInt(n, min, max){ n = Math.round(n); return Math.max(min, Math.min(max, n)); }
    function fmtARS(n){ const v = Number.isFinite(n) ? n : 0; return v.toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0}); }
    function fmtUSD(n){ const v = Number.isFinite(n) ? n : 0; return v.toLocaleString("es-AR",{style:"currency",currency:"USD",maximumFractionDigits:2}); }
    function toISODate(d){ const z = new Date(d); const y=z.getFullYear(); const m=String(z.getMonth()+1).padStart(2,"0"); const day=String(z.getDate()).padStart(2,"0"); return `${y}-${m}-${day}`; }
    function cryptoId(){ return (crypto?.randomUUID ? crypto.randomUUID() : ("id_" + Math.random().toString(16).slice(2) + Date.now().toString(16))); }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[c])); }
    function downloadText(text, filename, mime){
      const blob = new Blob([text], { type: mime });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }
    function csvCell(v){
      const s = v === null || v === undefined ? "" : String(v);
      const escaped = s.replace(/"/g,'""');
      return /[",\n]/.test(escaped) ? `"${escaped}"` : escaped;
    }
    function saveCache(obj){ try{ localStorage.setItem(CACHE_KEY, JSON.stringify({ ...obj, cachedAt: Date.now() })); } catch(e){} }
    function loadCache(){ try{ const raw = localStorage.getItem(CACHE_KEY); return raw ? JSON.parse(raw) : null; } catch(e){ return null; } }

    // Init UI
    recalcChips();
    render();
  </script>
</body>
</html>
